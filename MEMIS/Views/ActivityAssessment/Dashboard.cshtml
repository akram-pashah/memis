@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor httpContextAccessor
@using System.Text.Json
@using MEMIS.ViewModels.ME
@model TotalActivityAssessmentDetailsViewModel

@{
    ViewData["Title"] = "Dashboard - M & E";



    Layout = "~/Pages/Shared/_ContentNavbarLayout.cshtml";



    var userDetails = new

    {

        UserName = httpContextAccessor.HttpContext?.Session.GetString("UserName"),

        UserRoles = httpContextAccessor.HttpContext.Session.GetString("UserRoles")

    };
}
@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/apex-charts/apex-charts.css" />
}
@section VendorScripts {
    <script src="~/vendor/libs/apex-charts/apexcharts.js"></script>
}
@section PageScripts {
    <script src="~/js/dashboards-analytics.js"></script>
    <script type="text/javascript">
        (function () {
            try {
              const currentYear = new Date().getFullYear();
            const financialYears = [];

            // Find the starting year (FY1) based on the current year
            const startYear = currentYear - ((currentYear - 1) % 5); // FY1 starts at the closest year divisible by 5 + 1

            // Calculate 5 financial years starting from the determined startYear
            for (let i = 0; i < 5; i++) {
                const fy = startYear + i;
                financialYears.push(fy);
            }

            // By default, select the current year and find its financial year label (FY1-FY5)
            const currentFYIndex = (currentYear - startYear) % 5; // 0 for FY1, 1 for FY2, and so on
            const selectedFY = `FY${currentFYIndex + 1} (${currentYear})`;
            document.getElementById("selectedFY").innerText = selectedFY;

            // Generate financial year dropdown options dynamically
            const dropdown = document.getElementById("financialYearDropdown");
            financialYears.forEach((year, index) => {
                const fyLabel = `FY${index+1} (${year})`;
                const dropdownItem = `<a class="dropdown-item" href="javascript:void(0);" onclick="updateChartData(${year});">${fyLabel}</a>`;
                dropdown.innerHTML += dropdownItem;
            });

            updateChartData(currentYear);
            } catch(error){
                console.log(error);
            }

            strategicInterTrendAnalysis();
            focusAreaContribution();
            focusAreaTrendLine();
            focusAreaTrendAnalysis();
        })();

        var chart = null;

        // Function to initialize the stacked chart
        function initializeChart(seriesData) {
            if (chart) {
                chart.destroy();
                chart = null;
            }

            var options = {
                series: [{
                    name: 'Fully Implemented',
                    data: seriesData.implemented
                }, {
                    name: 'Partially Implemented',
                    data: seriesData.partiallyImplemented
                }, {
                    name: 'Not Implemented',
                    data: seriesData.notImplemented
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    stacked: true,
                    stackType: '100%'
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        legend: {
                            position: 'bottom',
                            offsetX: -10,
                            offsetY: 0
                        }
                    }
                }],
                xaxis: {
                    categories: seriesData.categories,
                },
                fill: {
                    opacity: 1
                },
                legend: {
                    position: 'right',
                    offsetX: 0,
                    offsetY: 50
                },
            };

            chart = new ApexCharts(document.querySelector("#achievementFY1Chart"), options);
            chart.render();
        }

        // Function to handle chart data update on financial year change
        function updateChartData(year) {
            document.getElementById("selectedFY").innerText = year;

            // Fetch the data for the selected year via an AJAX call
            fetch(`/ActivityAssessment/GetFinancialYearData?year=${year}`)
                .then(response => response.json())
                .then(data => {
                    // Update the chart series and categories with new data
                    // updateChart(data);
                    initializeChart(data);
                })
                .catch(error => {
                    console.error('Error fetching financial year data:', error);
                });
        }

        function strategicInterTrendAnalysis(){
          var options = {
          series:@Html.Raw(JsonSerializer.Serialize(Model.YearlyStrategicInterventionTrend)),
          chart: {
          type: 'bar',
        },
        plotOptions: {
          bar: {
            horizontal: true,
            columnWidth: '55%',
            endingShape: 'rounded'
          },
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 2,
          colors: ['transparent']
        },
        xaxis: {
          categories: @Html.Raw(JsonSerializer.Serialize(Model.StrategicInterventions)),
        },
        yaxis: {
          title: {
            text: 'Trend Analysis of Strategic Interventions Fully Implemented'
          }
        },
        fill: {
          opacity: 1
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + "%"
            }
          }
        }
        };

        var chart = new ApexCharts(document.querySelector("#strategicIntervTrendAnalysis"), options);
        chart.render();
        }

        function focusAreaContribution(){
          var options = {
          series: [{
          name: '% of contribution',
          data: @Html.Raw(JsonSerializer.Serialize(Model.FocusAreasPercentages))
        }],
          chart: {
          height: 350,
          type: 'bar',
        },
        plotOptions: {
          bar: {
            borderRadius: 10,
            dataLabels: {
              position: 'top', // top, center, bottom
            },
          }
        },
        dataLabels: {
          enabled: true,
          formatter: function (val) {
            return val + "%";
          },
          offsetY: -20,
          style: {
            fontSize: '12px',
            colors: ["#304758"]
          }
        },
        
        xaxis: {
          categories: @Html.Raw(JsonSerializer.Serialize(Model.FocusAreas)),
          position: 'top',
          axisBorder: {
            show: false
          },
          axisTicks: {
            show: false
          },
          crosshairs: {
            fill: {
              type: 'gradient',
              gradient: {
                colorFrom: '#D8E3F0',
                colorTo: '#BED1E6',
                stops: [0, 100],
                opacityFrom: 0.4,
                opacityTo: 0.5,
              }
            }
          },
          tooltip: {
            enabled: true,
          }
        },
        yaxis: {
          axisBorder: {
            show: false
          },
          axisTicks: {
            show: false,
          },
          labels: {
            show: false,
            formatter: function (val) {
              return val + "%";
            }
          }
        
        },
        title: {
          text: 'Monthly Inflation in Argentina, 2002',
          floating: true,
          offsetY: 330,
          align: 'center',
          style: {
            color: '#444'
          }
        }
        };

        var chart = new ApexCharts(document.querySelector("#focusAreaContributionChart"), options);
        chart.render();
        }

        function focusAreaTrendLine(){
          var options = {
          series: @Html.Raw(JsonSerializer.Serialize(Model.YearlyStrategicPlanTrend)),
          chart: {
          height: 350,
          type: 'line',
          dropShadow: {
            enabled: true,
            color: '#000',
            top: 18,
            left: 7,
            blur: 10,
            opacity: 0.2
          },
          zoom: {
            enabled: false
          },
          toolbar: {
            show: false
          }
        },
        colors: ['#77B6EA', '#f5500a'],
        dataLabels: {
          enabled: true,
        },
        stroke: {
          curve: 'smooth'
        },
        title: {
          text: 'Strategic Plan Performance Trend Analysis since 2016',
          align: 'center'
        },
        grid: {
          borderColor: '#e7e7e7',
          row: {
            colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
            opacity: 0.5
          },
        },
        markers: {
          size: 1
        },
        xaxis: {
          categories: @Html.Raw(JsonSerializer.Serialize(Model.Years)),
          title: {
            text: 'Period in Years'
          }
        },
        yaxis: {
          title: {
            text: 'Percentage Achievements'
          },
          min: 0,
          max: 100
        },
        legend: {
          position: 'top',
          horizontalAlign: 'right',
          floating: true,
          offsetY: -25,
          offsetX: -5
        }
        };

        var chart = new ApexCharts(document.querySelector("#trendAnalysisLineChart"), options);
        chart.render();
        }

                function focusAreaTrendAnalysis(){
          var options = {
          series:@Html.Raw(JsonSerializer.Serialize(Model.YearlyFocusAreaTrend)),
          chart: {
          type: 'bar',
        },
        plotOptions: {
          bar: {
            horizontal: true,
            columnWidth: '55%',
            endingShape: 'rounded'
          },
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 2,
          colors: ['transparent']
        },
        xaxis: {
          categories: @Html.Raw(JsonSerializer.Serialize(Model.FocusAreas)),
        },
        yaxis: {
          title: {
            text: 'Comparitive Analysis of the Strategic Interventions Output Achievement'
          }
        },
        fill: {
          opacity: 1
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + "%"
            }
          }
        }
        };

        var chart = new ApexCharts(document.querySelector("#focusAreaTrendAnalysis"), options);
        chart.render();
        }

    </script>

}

@* ************** Content ************** *@
<div class="row">
    <div class="col-lg-8 mb-4 order-0">
        <div class="card">
            <div class="d-flex align-items-end row">
                <div class="col-sm-7">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Welcome, @userDetails.UserName! 🎉</h5>
                        <p class="mb-4">
                            &nbsp;
                        </p>

                        <a>&nbsp;</a>
                    </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                    <div class="card-body pb-0 px-0 px-md-4">
                        <img src="~/img/illustrations/man-with-laptop-light.png" height="140" alt="View Badge User" data-app-dark-img="illustrations/man-with-laptop-dark.png" data-app-light-img="illustrations/man-with-laptop-light.png">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 order-1">
        <div class="row">
            <div class="col-lg-6 col-md-12 col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="~/img/icons/unicons/chart-success.png" alt="chart success" class="rounded">
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt3" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt3">
                                    <a class="dropdown-item" href="javascript:void(0);">View More</a>
                                </div>
                            </div>
                        </div>
                        <span class="fw-medium d-block mb-1">Activities Fully Implemented</span>
                        <h3 class="card-title mb-2">@Model.TotalActivitiesFullyImplemented</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-12 col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="~/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded">
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt6" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt6">
                                    <a class="dropdown-item" href="javascript:void(0);">View More</a>
                                </div>
                            </div>
                        </div>
                        <span>Total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SDTs Achieved</span>
                        <h3 class="card-title text-nowrap mb-1">@Model.TotalSDTsAchieved</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Total Activities By Department -->
    <div class="col-12 col-lg-10 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card">
            <div class="row row-bordered g-0">
                <div class="col-md-12">
                    <h5 class="card-header m-0 me-2 pb-3">Output Achievement For FY1</h5>
                    <div class="card-body">
                        <div class="float-right">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="growthReportId" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span id="selectedFY"></span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="growthReportId" id="financialYearDropdown">
                                    <!-- Financial year options will be dynamically generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="achievementFY1Chart" class="px-2"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-10 col-lg-2 order-3 order-md-2">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="~/img/icons/unicons/paypal.png" alt="Credit Card" class="rounded">
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt4" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt4">
                                    <a class="dropdown-item" href="javascript:void(0);">View More</a>
                                    <a class="dropdown-item" href="javascript:void(0);">Delete</a>
                                </div>
                            </div>
                        </div>
                        <span class="d-block mb-1">Total KPIs Achieved</span>
                        <h3 class="card-title text-nowrap mb-2">@Model.TotalKPIsAchieved</h3>
                    </div>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="~/img/icons/unicons/cc-primary.png" alt="Credit Card" class="rounded">
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu" aria-labelledby="cardOpt1">
                                    <a class="dropdown-item" href="javascript:void(0);">View More</a>
                                </div>
                            </div>
                        </div>
                        <span class="fw-medium d-block mb-1">Department Performance</span>
                        <h3 class="card-title mb-2">@Model.DepartmentPerformance</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Total Activities By Department -->
    <!-- Total Activities By Focus Area -->
    <div class="col-12 col-lg-10 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card">
            <div class="row row-bordered g-0">
                <div class="col-md-12">
                    <h5 class="card-header m-0 me-2 pb-3">Trend Analysis of Strategic Interventions Fully Implemented</h5>
                    <div id="strategicIntervTrendAnalysis" class="px-2"></div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Total Activities By Focus Area -->
</div>
<div class="row">
    <!-- Order Statistics -->
    <div class="col-md-12 col-lg-12 col-xl-12 order-0 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Contribution of Each Focus Area to the overall Output Achievement (Implementation & Output)</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex flex-column align-items-center gap-1">
                        <h2 class="mb-2">@Model.TotalActivitiesFullyImplemented</h2>
                        <span>Total Budget</span>
                    </div>
                </div>
                <div id="focusAreaContributionChart"></div>
            </div>
        </div>
    </div>
    <!--/ Order Statistics -->
    <!-- Expense Overview -->
        <div class="col-md-12 col-lg-12 order-1 mb-4">
    <div class="card h-100">
    <div class="card-header">
    Strategic Plan Performance Trend Analysis since 2016
    </div>
    <div class="card-body px-0">
    <div class="tab-content p-0">
    <div class="tab-pane fade show active" id="navs-tabs-line-card-income" role="tabpanel">
    <div id="trendAnalysisLineChart"></div>
    </div>
    </div>
    </div>
    </div>
    </div>
       <!--/ Expense Overview -->
    <!-- Transactions -->
    <div class="col-md-12 col-lg-12 order-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">Comparitive Analysis of the Strategic Interventions Output Achievement</h5>
            </div>
            <div class="card-body">
              <div id="focusAreaTrendAnalysis"></div>
            </div>
        </div>
    </div>
    <!--/ Transactions -->
</div>
